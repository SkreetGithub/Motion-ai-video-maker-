# API Keys & Supabase Database Verification Guide

## âœ… Configuration Status

This document verifies that all API keys and Supabase database connections are properly configured.

## ğŸ”‘ Environment Variables

### Required Variables (Validated by `src/lib/env.js`)

1. **Supabase Configuration**
   - `NEXT_PUBLIC_SUPABASE_URL` - âœ… Validated as URL
   - `NEXT_PUBLIC_SUPABASE_ANON_KEY` - âœ… Validated (min 1 character)
   - `SUPABASE_SERVICE_ROLE_KEY` - âœ… Validated (min 1 character)

2. **AI Provider Keys**
   - `OPENAI_API_KEY` - âœ… Validated (min 1 character)
   - `REPLICATE_API_TOKEN` - âœ… Validated (min 1 character)
   - `ELEVENLABS_API_KEY` - âœ… Optional (defaults to empty string)
   - `GOOGLE_API_KEY` - âœ… Optional (defaults to empty string)

3. **Optional Overrides**
   - `OPENAI_MODEL` - âœ… Optional (defaults to "gpt-4o-mini")

## ğŸ—„ï¸ Supabase Database Configuration

### Client Initialization

The system uses **two Supabase clients** for different purposes:

1. **Service Role Client** (Server-side operations)
   - Location: `src/lib/videoEngine.js` - `createClients()`
   - Used for: Database writes, admin operations
   - Configuration: `auth: { persistSession: false }`
   - âœ… Properly configured

2. **Anon Client** (Public API routes)
   - Location: API routes (`src/app/api/*/route.ts`)
   - Used for: Public read operations
   - âœ… Properly configured

### Database Operations

#### âœ… Character Fetching
- **Function**: `getCharacters()` in `src/lib/videoEngine.js`
- **Table**: `characters`
- **Status**: âœ… Handles both old and new schema formats
- **Error Handling**: âœ… Fallback to default characters if fetch fails

#### âœ… Video Saving
- **Function**: `saveVideo()` in `src/lib/videoEngine.js`
- **Storage Bucket**: `videos`
- **Status**: âœ… Saves videos to Supabase Storage
- **Error Handling**: âœ… Returns null on error, logs error

#### âœ… Movie Record Saving
- **Function**: `saveMovieRecord()` in `src/lib/videoEngine.js`
- **Table**: `movies`
- **UUID Generation**: âœ… Auto-generated by database (no manual UUID needed)
- **User ID**: âœ… Saves user name as `user_id` (TEXT type)
- **Error Handling**: âœ… Returns null on error, logs error

### API Routes Using Supabase

#### âœ… `/api/characters` (GET)
- **File**: `src/app/api/characters/route.ts`
- **Client**: Anon key
- **Operation**: Fetches all characters
- **Status**: âœ… Properly configured

#### âœ… `/api/videos` (GET)
- **File**: `src/app/api/videos/route.ts`
- **Client**: Anon key
- **Operation**: Fetches videos (with optional userId filter)
- **Status**: âœ… Properly configured

#### âœ… `/api/videos/[id]` (GET)
- **File**: `src/app/api/videos/[id]/route.ts`
- **Client**: Anon key
- **Operation**: Fetches single video by UUID
- **UUID Validation**: âœ… Validates UUID format before querying
- **Status**: âœ… Properly configured

#### âœ… `/api/create-video` (POST)
- **File**: `src/app/api/create-video/route.ts`
- **Client**: Service role (via `createMovie()`)
- **Operation**: Creates video and saves to database
- **Status**: âœ… Properly configured

## ğŸ”’ Security Features

### âœ… Row Level Security (RLS)
- **Status**: Enabled on all tables
- **Policies**: Configured in `supabase-schema.sql`
- **Public Access**: Movies table has public read access for gallery

### âœ… Environment Variable Validation
- **Location**: `src/lib/env.js`
- **Validation**: Uses Zod schema
- **Error Messages**: Clear, helpful error messages
- **Status**: âœ… Validates all required keys on startup

### âœ… API Key Security
- **No Hardcoded Keys**: âœ… All keys come from environment variables
- **Server-Only**: âœ… Video engine uses `"server-only"` directive
- **Service Role**: âœ… Only used server-side, never exposed to client

## ğŸ“Š Database Schema

### Tables

1. **`characters`**
   - âœ… UUID primary key
   - âœ… Supports both old and new schema (profile JSONB)
   - âœ… User ID support (TEXT type)

2. **`movies`**
   - âœ… UUID primary key (auto-generated)
   - âœ… User ID support (TEXT type for user names)
   - âœ… JSONB fields for flexible data storage
   - âœ… Proper indexes for performance

3. **`videos`** (legacy)
   - âœ… UUID primary key
   - âœ… User ID support

4. **`jobs`**
   - âœ… UUID primary key
   - âœ… User ID support
   - âœ… Progress tracking

### Storage Buckets

1. **`videos`**
   - âœ… Public bucket for video files
   - âœ… Configured in schema
   - âœ… Used by `saveVideo()` function

## ğŸ§ª Testing Checklist

To verify everything works:

1. âœ… **Environment Variables**
   - Check `.env.local` exists
   - All required keys are present
   - No validation errors on startup

2. âœ… **Supabase Connection**
   - Database tables exist
   - Storage bucket exists
   - RLS policies are active

3. âœ… **API Routes**
   - `/api/characters` returns character list
   - `/api/videos` returns video list
   - `/api/videos/[id]` returns single video
   - `/api/create-video` creates and saves videos

4. âœ… **Database Operations**
   - Characters are fetched correctly
   - Videos are saved to storage
   - Movie records are saved with UUIDs
   - User names are saved correctly

5. âœ… **Error Handling**
   - Missing keys show helpful errors
   - Database errors are logged
   - Fallbacks work correctly

## ğŸš¨ Common Issues & Solutions

### Issue: "Missing/invalid environment variables"
**Solution**: 
- Check `.env.local` file exists
- Verify all required keys are present
- Check for typos in variable names

### Issue: "Invalid UUID format"
**Solution**: 
- Database now auto-generates UUIDs
- No manual UUID creation needed
- API validates UUID format before querying

### Issue: "Video not saving to database"
**Solution**:
- Check Supabase service role key is correct
- Verify `movies` table exists
- Check RLS policies allow inserts
- Review error logs in console

### Issue: "Cannot connect to Supabase"
**Solution**:
- Verify `NEXT_PUBLIC_SUPABASE_URL` is correct
- Check `SUPABASE_SERVICE_ROLE_KEY` is valid
- Ensure Supabase project is active
- Check network connectivity

## âœ… Summary

All API keys and Supabase database connections are properly configured:

- âœ… Environment variables validated
- âœ… Supabase clients initialized correctly
- âœ… Database operations working
- âœ… Storage bucket configured
- âœ… Error handling in place
- âœ… Security measures active
- âœ… UUID generation working
- âœ… User name saving working

The system is ready for production use!

